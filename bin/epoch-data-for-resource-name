#!/usr/bin/env python3
# -*- mode: Python;-*-

import htcondor2

# import argparse
# import inspect
# import numbers
import sys


def configure_htcondor():
    # See https://opensciencegrid.atlassian.net/browse/INF-760
    htcondor2.param['SEC_CLIENT_AUTHENTICATION_METHODS'] = 'SSL FS'

    # Suggested by Brian L., I think, at some point
    htcondor2.param['SEC_CLIENT_AUTHENTICATION'] = 'OPTIONAL'
    htcondor2.param['SEC_CLIENT_INTEGRITY'] = 'OPTIONAL'
    htcondor2.param['SEC_CLIENT_ENCRYPTION'] = 'OPTIONAL'

    # Debugging
    # htcondor2.param['TOOL_DEBUG'] = 'D_SECURITY:2 D_CAT D_ALWAYS:2'
    # htcondor2.enable_debug()


def get_ospool_schedds(ospool_collectors):
    ospool_schedd_names = {}   # schedd name => [count, schedd classad]
    for ospool_collector_hostname in ospool_collectors:
        ospool_collector = htcondor2.Collector(ospool_collector_hostname)
        ospool_schedd_classad_list = ospool_collector.locateAll(htcondor2.DaemonTypes.Schedd)
        for ospool_schedd_classad in ospool_schedd_classad_list:
            ospool_schedd_name = ospool_schedd_classad['Name']
            if ospool_schedd_name in ospool_schedd_names:
                ospool_schedd_names[ospool_schedd_name][0] += 1
            else:
                ospool_schedd_names[ospool_schedd_name] = [1, ospool_schedd_classad]
    printed_one = False
    for ospool_schedd_name in ospool_schedd_names:
        found_count = ospool_schedd_names[ospool_schedd_name][0]
        if found_count != len(ospool_collectors):
            print(f'Found schedd in only {found_count} collector(s): "{ospool_schedd_name}"', file=sys.stderr)
            printed_one = True
    if printed_one:
        print()
    return ospool_schedd_names

# https://htcondor.readthedocs.io/en/latest/apis/python-bindings/api/version2/htcondor2/schedd.html#htcondor2.Schedd.jobEpochHistory

def cli():
    # FACTORY_HOSTS = ('gfactory-1.osg-htc.org')
    OSPOOL_COLLECTORS = ['cm-1.ospool.osg-htc.org', 'cm-2.ospool.osg-htc.org']
    # args = parse_arguments()
    # print()

    configure_htcondor()
    ospool_schedds = get_ospool_schedds(OSPOOL_COLLECTORS)

if __name__ == '__main__':
    cli()
